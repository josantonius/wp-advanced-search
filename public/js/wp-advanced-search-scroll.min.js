document.addEventListener("DOMContentLoaded", function (event)
{

    function getQueryStringValue(key)
    {
        return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
    }
    var index = getQueryStringValue("index");
    var tags = 'h1,h2,h3,h4,h5,h6,p';


    if (!index || !index.length > 0)
    {

    } else
    {

        var arrayTags = tags.split(',');
        var needle = getQueryStringValue("search");
        needle = needle.replace(/,/g, ' ');
        var arrayNeedle = needle.split(' ');
        var search_by_words = getQueryStringValue("by_words");
        var search_by_sentence = getQueryStringValue("by_sentence");


        var condition = '';

        var count = arrayTags.length;

        var tags = '';

        arrayTags.forEach(function (tag)
        {
            condition += `self::${tag} or `;
        });

        condition = condition.replace(/ or +$/g, "");

        var contains = '';

        if (search_by_sentence == 1)
        {
            contains += `
        contains(
            normalize-space(
                translate(
                    .,
                    'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    'abcdefghijklmnopqrstuvwxyz'
                )
            ),
            "${needle}"
        ) or`;
        }

        if (search_by_words == 1)
        {
            contains += '(';
            arrayNeedle.forEach(function (word)
            {
                if (word.length >= 3)
                {
                    contains += `
                contains(
                    normalize-space(
                        translate(
                            .,
                            'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                            'abcdefghijklmnopqrstuvwxyz'
                        )
                    ),
                    "${word}"
                ) or`;
                }
            })
            contains = contains.replace(/ or+$/g, "");
        }

        var end = search_by_words ? ')' : '';

        contains = contains.replace(/ or+$/g, "") + end;

        var query = `//*[${condition}][${contains}]`;

        function getElementByXpath(xpathToExecute)
        {
            var el = document.getElementsByClassName('status-publish');
            if (!el[0])
            {
                el = document.getElementsByClassName('hkb-article');
                // el = document.getElementsByClassName('hkb-article__content');
            }

            var result = [];
            if (el[0])
            {
                var nodesSnapshot = document.evaluate(xpathToExecute, el[0], null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
                for (var i = 0; i < nodesSnapshot.snapshotLength; i++)
                {
                    result.push(nodesSnapshot.snapshotItem(i));
                }
            }
            return result;
        }

        var elements = getElementByXpath(query);
        console.log('ELEMENTS', elements)
        if (elements[index])
        {
            setTimeout(() =>
            {
                console.log('ELEMENT', elements[index].tagName, elements[index].innerText)
                elements[index].scrollIntoView(true);
                window.scrollBy(0, -35);
            }, 800);
        }
    }
});